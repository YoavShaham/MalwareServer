'use strict'

const {EventEmitter} = require('events')
const emiter = new EventEmitter()
require('dotenv').config()

const {initialize_app, dissconect_app, app} = require('./app/app')
const repository = require('./repository/repository')


process.on('uncaughtException', (err) => {
    console.error('Uncaught exception', err)
    process.exit(1)
})

process.on('uncaughtRejection', (err, promise) => {
    console.error('Uncaught rejection', err)
    process.exit(1)
})

let rep
const connection = repository.virus_total_connect(process.env.API_KEY)
.then(repo =>{
    console.log('virus total connected')

    rep = repo

    try{
        return initialize_app({port: process.env.VIRUS_TOTAL_SERVICE_PORT, repo:rep})
    }
    catch(exception){
        throw new Error("failed to listen on required port")
    }
})

process.on('SIGTERM', dissconect_app);
process.on('SIGINT', dissconect_app);

emiter.emit('boot ready')