
const express = require('express')
const api = require('../api/virus-total-api')
const cors = require('cors')
const helmet = require('helmet')

api_key = 'bc9b42cf3bbaf3ffe4ae7f538b34774310fa49e4614d48a90ccbb171a9e553bc'
const initialize_app = (options)  => {
    return new Promise((resolve, reject) => {
        // checking the appropriate requirments
        if(!options.repo){
            reject(new Error("The service requires woring repository"))
        }

        if(!options.port){
            reject(new Error("The service requires open port"))
        }
    
        const app = express()
        app.use(express.json())
        app.use(cors())
        app.use(helmet())
        app.use((err, req, res, next) => {
            reject(new Error('An error occured:' + err))
            res.send('faild to initialize sqlite service app')
        })
        
        // initializing the virus-total api
        api(app, options)  

        // stating listening for the virus-total service
        const server = app.listen(options.port, () => resolve(server))
    })

}

let reposit
const connection = repository.virus_total_connect(api_key)
.then(repo =>{
    console.log('virus total connected')

    reposit = repo
})

module.exports = Object.assign({}, {initialize_app})
