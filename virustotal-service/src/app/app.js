
const express = require('express')
const api = require('../api/virus-total-api')
const cors = require('cors')
const helmet = require('helmet')

const app = express()
var server

const initialize_app = (options)  => {
    return new Promise((resolve, reject) => {
        // checking the appropriate requirments
        if(!options.repo){
            reject(new Error("The service requires working repository"))
        }

        if(!options.port){
            reject(new Error("The service requires open port"))
        }
    
        app.use(express.json())
        app.use(cors())
        app.use(helmet())
        app.use((err, req, res, next) => {
            reject(new Error('An error occured:' + err))
            res.send('faild to initialize backend express')
        })
        
        // initializing the virus-total api
        api(app, options)  

        // stating listening for the virus-total service
        server = app.listen(options.port, () => resolve(server))
    })

}

const dissconect_app = () =>{
    return new Promise((resolve, reject) => {
        server.close()
    })
}

module.exports = {initialize_app, dissconect_app, app}
