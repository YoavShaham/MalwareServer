'use strict'

const {EventEmitter} = require('events')
const app = require('./app/app')
const emiter = new EventEmitter()
const server = require('./app/app')
const repository = require('./repository/repository')
const parse_files = require('./repository/parsefiles')

const db_path = './db-service/src/attacks.sqlite';
const attacks_files_dir_path = './db-service/src/attack/';
const application_port = 9001

process.on('uncaughtException', (err) => {
    console.error('Uncaught exception', err)
})

process.on('uncaughtRejection', (err, promise) => {
    console.error('Uncaught rejection', err)
})


let rep

parse_files.parse_attacks(attacks_files_dir_path, db_path)
.then(
repository.db_connect(db_path)
.then(repo =>{
    console.log('db connected')

    rep = repo

    return server.initialize_app({port: application_port, repo:rep})
}))


emiter.emit('boot ready')